<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shade Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">Shade Finder</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Find the perfect spot to relax.</p>
        </div>

        <!-- Location Section -->
        <div id="location-section" class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div id="loader" class="loader mx-auto"></div>
            <div id="location-content" class="hidden">
                 <p class="text-sm">Your Location:</p>
                 <p class="font-semibold" id="coords">Fetching...</p>
                 <button id="getLocationBtn" class="mt-2 text-xs text-blue-500 hover:underline">Refresh Location</button>
            </div>
             <p id="error-message" class="text-red-500 text-sm hidden"></p>
        </div>

        <!-- Visualization -->
        <div class="relative w-full aspect-square bg-green-100 dark:bg-green-900/50 rounded-lg overflow-hidden border-2 border-gray-200 dark:border-gray-700">
             <svg id="sky" viewBox="0 0 200 200" class="absolute inset-0 w-full h-full">
                <!-- Compass Rose -->
                <text x="96" y="15" font-size="8" fill="currentColor" class="opacity-50 font-semibold">N</text>
                <text x="96" y="190" font-size="8" fill="currentColor" class="opacity-50 font-semibold">S</text>
                <text x="10" y="104" font-size="8" fill="currentColor" class="opacity-50 font-semibold">W</text>
                <text x="182" y="104" font-size="8" fill="currentColor" class="opacity-50 font-semibold">E</text>
                <line x1="100" y1="18" x2="100" y2="25" stroke="currentColor" stroke-width="0.5" class="opacity-50"/>
                <line x1="100" y1="182" x2="100" y2="175" stroke="currentColor" stroke-width="0.5" class="opacity-50"/>
                <line x1="18" y1="100" x2="25" y2="100" stroke="currentColor" stroke-width="0.5" class="opacity-50"/>
                <line x1="182" y1="100" x2="175" y2="100" stroke="currentColor" stroke-width="0.5" class="opacity-50"/>

                <!-- Sun -->
                <circle id="sun" r="8" fill="#FFD700" stroke="orange" stroke-width="1"/>
                <!-- Shadow -->
                <circle id="shadow" cx="100" cy="100" r="20" fill="#3b82f6" fill-opacity="0.4"/>
                <!-- Umbrella -->
                <circle id="umbrella" cx="100" cy="100" r="20" fill="rgb(156 163 175 / 0.5)" stroke="rgb(107 114 128)" stroke-width="1.5"/>
            </svg>
            <div id="night-message" class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-lg font-semibold hidden">
                <p>It's nighttime!</p>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex justify-center items-center space-x-4 text-xs text-gray-600 dark:text-gray-400">
            <div class="flex items-center space-x-1.5">
                <span class="w-3 h-3 rounded-full bg-yellow-400 border border-orange-500"></span>
                <span>Sun</span>
            </div>
            <div class="flex items-center space-x-1.5">
                <span class="w-3 h-3 rounded-full bg-gray-400/50 border border-gray-500"></span>
                <span>Umbrella</span>
            </div>
            <div class="flex items-center space-x-1.5">
                <span class="w-3 h-3 rounded-full bg-blue-500/40"></span>
                <span>Shade</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="space-y-4">
            <!-- Umbrella Height -->
            <div>
                <label for="height" class="flex justify-between text-sm font-medium text-gray-700 dark:text-gray-300">
                    <span>Umbrella Height</span>
                    <span id="heightValue" class="font-bold text-blue-600 dark:text-blue-400">7 ft</span>
                </label>
                <input id="height" type="range" min="4" max="10" value="7" step="0.5" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
            </div>
            <!-- Umbrella Diameter -->
            <div>
                <label for="diameter" class="flex justify-between text-sm font-medium text-gray-700 dark:text-gray-300">
                    <span>Umbrella Diameter</span>
                    <span id="diameterValue" class="font-bold text-blue-600 dark:text-blue-400">9 ft</span>
                </label>
                <input id="diameter" type="range" min="4" max="15" value="9" step="1" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
            </div>
            <!-- Time of Day -->
            <div>
                <label for="time" class="flex justify-between text-sm font-medium text-gray-700 dark:text-gray-300">
                    <span>Time of Day</span>
                    <span id="timeValue" class="font-bold text-blue-600 dark:text-blue-400">12:00 PM</span>
                </label>
                <input id="time" type="range" min="0" max="1439" value="720" step="15" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const heightSlider = document.getElementById('height');
            const heightValue = document.getElementById('heightValue');
            const diameterSlider = document.getElementById('diameter');
            const diameterValue = document.getElementById('diameterValue');
            const timeSlider = document.getElementById('time');
            const timeValue = document.getElementById('timeValue');

            const umbrellaSVG = document.getElementById('umbrella');
            const shadowSVG = document.getElementById('shadow');
            const sunSVG = document.getElementById('sun');
            const nightMessage = document.getElementById('night-message');
            
            const coordsDisplay = document.getElementById('coords');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const loader = document.getElementById('loader');
            const locationContent = document.getElementById('location-content');
            const errorMessage = document.getElementById('error-message');

            let userLat = 34.0522; // Default to Los Angeles
            let userLon = -118.2437;
            const FEET_TO_METERS = 0.3048;
            const VIEWBOX_SIZE = 200; // SVG viewBox is 200x200
            
            // --- UI UPDATE FUNCTIONS ---
            function updateSliderValue(slider, display, unit, isTime = false) {
                if (isTime) {
                    const totalMinutes = parseInt(slider.value);
                    const hours = Math.floor(totalMinutes / 60) % 24;
                    const minutes = totalMinutes % 60;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayHours = hours % 12 === 0 ? 12 : hours % 12;
                    const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
                    display.textContent = `${displayHours}:${displayMinutes} ${ampm}`;
                } else {
                    display.textContent = `${slider.value} ${unit}`;
                }
            }

            // --- CORE CALCULATION & DRAWING ---
            function calculateAndDraw() {
                if (!userLat || !userLon) return;

                const heightInFeet = parseFloat(heightSlider.value);
                const diameterInFeet = parseFloat(diameterSlider.value);
                
                // Scale factor to fit the umbrella and its shadow in the viewbox
                const maxPossibleShadow = (10 / Math.tan(0.1)); // Max height at low sun angle
                const scale = VIEWBOX_SIZE / ((15 * 2) + maxPossibleShadow); // Base on max diameter

                const radiusInFeet = diameterInFeet / 2;
                const radiusScaled = radiusInFeet * scale;
                
                umbrellaSVG.setAttribute('r', radiusScaled);
                shadowSVG.setAttribute('r', radiusScaled);
                
                const totalMinutes = parseInt(timeSlider.value);
                const now = new Date();
                now.setHours(Math.floor(totalMinutes / 60));
                now.setMinutes(totalMinutes % 60);

                const sunPosition = SunCalc.getPosition(now, userLat, userLon);
                
                // Sun is below the horizon
                if (sunPosition.altitude <= 0) {
                    nightMessage.classList.remove('hidden');
                    shadowSVG.classList.add('hidden');
                    sunSVG.classList.add('hidden');
                    return;
                }
                
                nightMessage.classList.add('hidden');
                shadowSVG.classList.remove('hidden');
                sunSVG.classList.remove('hidden');

                const shadowOffset = (heightInFeet / Math.tan(sunPosition.altitude)) * scale;

                // SunCalc azimuth: 0 is South, positive clockwise.
                // Convert to standard Cartesian angle: 0 is East (right), positive counter-clockwise.
                // SVG coordinates: y-axis is inverted.
                const cartesianAzimuth = sunPosition.azimuth + Math.PI / 2;
                const shadowAngle = cartesianAzimuth + Math.PI; // Opposite direction for shadow
                
                const shadowX = 100 + shadowOffset * Math.cos(shadowAngle);
                const shadowY = 100 - shadowOffset * Math.sin(shadowAngle); // Subtract for SVG y-inversion

                // Calculate sun's position for visualization
                // Map altitude (0 to PI/2) to a distance from the center (95 to 10)
                const sunDistance = 95 - (sunPosition.altitude / (Math.PI / 2)) * 85;
                const sunX = 100 + sunDistance * Math.cos(cartesianAzimuth);
                const sunY = 100 - sunDistance * Math.sin(cartesianAzimuth);

                sunSVG.setAttribute('cx', sunX);
                sunSVG.setAttribute('cy', sunY);

                shadowSVG.setAttribute('cx', shadowX);
                shadowSVG.setAttribute('cy', shadowY);
            }

            // --- GEOLOCATION ---
            function getLocation() {
                loader.style.display = 'block';
                locationContent.classList.add('hidden');
                errorMessage.classList.add('hidden');

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLat = position.coords.latitude;
                            userLon = position.coords.longitude;
                            coordsDisplay.textContent = `${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
                            loader.style.display = 'none';
                            locationContent.classList.remove('hidden');
                            calculateAndDraw();
                        },
                        () => {
                            handleLocationError("Could not get location. Using default.");
                        }
                    );
                } else {
                    handleLocationError("Geolocation not supported. Using default.");
                }
            }

            function handleLocationError(message) {
                 coordsDisplay.textContent = `${userLat.toFixed(4)}, ${userLon.toFixed(4)} (Default)`;
                 errorMessage.textContent = message;
                 errorMessage.classList.remove('hidden');
                 loader.style.display = 'none';
                 locationContent.classList.remove('hidden');
                 calculateAndDraw();
            }

            // --- EVENT LISTENERS ---
            heightSlider.addEventListener('input', () => {
                updateSliderValue(heightSlider, heightValue, 'ft');
                calculateAndDraw();
            });
            diameterSlider.addEventListener('input', () => {
                updateSliderValue(diameterSlider, diameterValue, 'ft');
                calculateAndDraw();
            });
            timeSlider.addEventListener('input', () => {
                updateSliderValue(timeSlider, timeValue, '', true);
                calculateAndDraw();
            });
            getLocationBtn.addEventListener('click', getLocation);

            // --- INITIALIZATION ---
            function initialize() {
                const now = new Date();
                const totalMinutes = now.getHours() * 60 + now.getMinutes();
                timeSlider.value = totalMinutes;

                updateSliderValue(heightSlider, heightValue, 'ft');
                updateSliderValue(diameterSlider, diameterValue, 'ft');
                updateSliderValue(timeSlider, timeValue, '', true);
                
                getLocation();
            }

            initialize();
        });
    </script>
</body>
</html>

